#!/bin/bash
# ==============================================================
#  PROXY SERVER INSTALLER
#  IPv4 (single) / IPv6 (up to 1000 unique exit IPs)
#  Optional web panel: http://IP/panel
#  Backend: 3proxy + nginx | OS: Ubuntu 20.04 / 22.04 / 24.04
# ==============================================================

echo ""
echo "  Proxy Installer: Р В·Р В°Р С—РЎС“РЎРѓР С”..."
echo ""

set -euo pipefail

# РІвЂќР‚РІвЂќР‚ Colors РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚
RED='\033[0;31m';   GREEN='\033[0;32m';  YELLOW='\033[1;33m'
BLUE='\033[0;34m';  CYAN='\033[0;36m';  MAGENTA='\033[0;35m'
WHITE='\033[1;37m'; NC='\033[0m';       BOLD='\033[1m'

# РІвЂќР‚РІвЂќР‚ Paths РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚
INSTALL_DIR="/etc/3proxy"
CONFIG_FILE="/etc/3proxy/3proxy.cfg"
LOG_DIR="/var/log/3proxy"
PROXY_LIST="/root/proxy_list.txt"
IPV6_SCRIPT="/usr/local/bin/add-proxy-ipv6.sh"
PANEL_DIR="/var/www/html/panel"
PANEL_CREDS="/root/panel_credentials.txt"
UPDATE_PANEL_CMD="/usr/local/bin/proxy-panel-update"

# РІвЂќР‚РІвЂќР‚ Global vars РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚РІвЂќР‚
PROXY_TYPE=""
PROXY_PROTOCOL="socks5"
PROXY_COUNT=1
OUTPUT_FORMAT=1
WANT_PANEL="no"
START_PORT=10000
SERVER_IPV4=""
NET_INTERFACE=""
IPV6_ADDR=""
IPV6_PREFIX_LEN="64"
PANEL_USER="admin"
PANEL_PASS=""
declare -a IPV6_ADDRESSES=()
declare -a PROXY_LOGINS=()
declare -a PROXY_PASSES=()

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# UTILITY
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

print_line() { echo -e "${CYAN}  РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’${NC}"; }
success()    { echo -e "${GREEN}  РІСљвЂњ  $1${NC}"; }
err()        { echo -e "${RED}  РІСљвЂ”  $1${NC}"; }
info()       { echo -e "${BLUE}  РІвЂћв„–  $1${NC}"; }
warn()       { echo -e "${YELLOW}  РІС™В   $1${NC}"; }
step()       { echo -e "\n${WHITE}${BOLD}  РІР‚С”  $1${NC}"; }

gen_random() { cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w "${1:-12}" | head -n 1; }

check_root() {
    [[ $EUID -ne 0 ]] && { echo -e "\n${RED}${BOLD}  Р СћРЎР‚Р ВµР В±РЎС“Р ВµРЎвЂљРЎРѓРЎРЏ root: sudo bash install.sh${NC}\n"; exit 1; }
}

check_os() {
    local ver
    ver=$(grep VERSION_ID /etc/os-release 2>/dev/null | grep -oE '[0-9]+' | head -1 || echo "")
    if ! grep -qi 'ubuntu' /etc/os-release 2>/dev/null; then
        warn "Р РЋР С”РЎР‚Р С‘Р С—РЎвЂљ Р С•Р С—РЎвЂљР С‘Р СР С‘Р В·Р С‘РЎР‚Р С•Р Р†Р В°Р Р… Р Т‘Р В»РЎРЏ Ubuntu. Р СџРЎР‚Р С•Р Т‘Р С•Р В»Р В¶Р С‘РЎвЂљРЎРЉ Р Р…Р В° Р Т‘РЎР‚РЎС“Р С–Р С•Р в„– Р С›Р РЋ?"
        echo -ne "  (yes/no): "; read -r ans
        [[ "${ans,,}" =~ ^(yes|y|Р Т‘Р В°)$ ]] || exit 0
    elif [[ "$ver" != "20" && "$ver" != "22" && "$ver" != "24" ]]; then
        warn "Р СџРЎР‚Р С•РЎвЂљР ВµРЎРѓРЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С• Р Р…Р В° Ubuntu 20/22/24. Р СћР ВµР С”РЎС“РЎвЂ°Р В°РЎРЏ: $ver. Р СџРЎР‚Р С•Р Т‘Р С•Р В»Р В¶Р С‘РЎвЂљРЎРЉ?"
        echo -ne "  (yes/no): "; read -r ans
        [[ "${ans,,}" =~ ^(yes|y|Р Т‘Р В°)$ ]] || exit 0
    fi
}

print_banner() {
    if [[ -t 1 ]] && command -v clear >/dev/null 2>&1; then
        clear || true
    fi
    echo -e "${CYAN}"
    echo "  РІвЂўвЂќРІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўвЂ”"
    echo "  РІвЂўвЂ                                                  РІвЂўвЂ"
    echo "  РІвЂўвЂ        P R O X Y   I N S T A L L E R            РІвЂўвЂ"
    echo "  РІвЂўвЂ        IPv4 / IPv6  РІР‚Сћ  Ubuntu 20/22/24           РІвЂўвЂ"
    echo "  РІвЂўвЂ                                                  РІвЂўвЂ"
    echo "  РІвЂўС™РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўСњ"
    echo -e "${NC}"
}

format_name() {
    case $OUTPUT_FORMAT in
        1) echo "IP:PORT:LOGIN:PASS"  ;;
        2) echo "IP:PORT@LOGIN:PASS"  ;;
        3) echo "LOGIN:PASS@IP:PORT"  ;;
        4) echo "LOGIN:PASS:IP:PORT"  ;;
    esac
}

format_proxy() {
    local ip=$1 port=$2 login=$3 pass=$4
    case $OUTPUT_FORMAT in
        1) echo "${ip}:${port}:${login}:${pass}" ;;
        2) echo "${ip}:${port}@${login}:${pass}" ;;
        3) echo "${login}:${pass}@${ip}:${port}" ;;
        4) echo "${login}:${pass}:${ip}:${port}" ;;
    esac
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# WIZARD РІР‚вЂќ STEP 1: PROXY TYPE
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

step_proxy_type() {
    print_banner
    echo -e "  ${WHITE}${BOLD}Р РЃР В°Р С– 1 Р С‘Р В· 6 РІР‚вЂќ Р СћР С‘Р С— Р С—РЎР‚Р С•Р С”РЎРѓР С‘${NC}\n"
    print_line; echo ""
    echo -e "  ${GREEN}[1]${NC}  ${WHITE}${BOLD}IPv4${NC}  РІР‚вЂќ Р С•Р Т‘Р Р…Р В° Р С—РЎР‚Р С•Р С”РЎРѓР С‘, Р Р†РЎвЂ№РЎвЂ¦Р С•Р Т‘ РЎвЂЎР ВµРЎР‚Р ВµР В· IPv4 РЎРѓР ВµРЎР‚Р Р†Р ВµРЎР‚Р В°"
    echo -e "       ${YELLOW}172.233.96.133:10000:login:password${NC}\n"
    echo -e "  ${GREEN}[2]${NC}  ${WHITE}${BOLD}IPv6${NC}  РІР‚вЂќ Р СР Р…Р С•Р С–Р С• Р С—РЎР‚Р С•Р С”РЎРѓР С‘, Р С”Р В°Р В¶Р Т‘Р В°РЎРЏ РЎРѓ РЎС“Р Р…Р С‘Р С”Р В°Р В»РЎРЉР Р…РЎвЂ№Р С IPv6"
    echo -e "       ${YELLOW}172.233.96.133:10001:login1:pass1  РІвЂ С’ РЎР‚Р В°Р В·Р Р…РЎвЂ№Р Вµ Р Р†РЎвЂ№РЎвЂ¦Р С•Р Т‘Р Р…РЎвЂ№Р Вµ IP${NC}"
    echo -e "       ${YELLOW}172.233.96.133:10002:login2:pass2${NC}"
    echo ""; print_line; echo ""
    while true; do
        echo -ne "  ${WHITE}Р вЂ™Р В°РЎв‚¬ Р Р†РЎвЂ№Р В±Р С•РЎР‚ (1 Р С‘Р В»Р С‘ 2): ${NC}"; read -r ch
        case $ch in
            1) PROXY_TYPE="ipv4"; break ;;
            2) PROXY_TYPE="ipv6"; break ;;
            *) err "Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ 1 Р С‘Р В»Р С‘ 2" ;;
        esac
    done
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# WIZARD РІР‚вЂќ STEP 2: COUNT (IPv6 only)
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

step_proxy_count() {
    [[ "$PROXY_TYPE" == "ipv4" ]] && { PROXY_COUNT=1; return; }
    print_banner
    echo -e "  ${WHITE}${BOLD}Р РЃР В°Р С– 2 Р С‘Р В· 6 РІР‚вЂќ Р С™Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С• Р С—РЎР‚Р С•Р С”РЎРѓР С‘${NC}\n"
    print_line; echo ""
    echo -e "  Р С™Р В°Р В¶Р Т‘Р В°РЎРЏ Р С—РЎР‚Р С•Р С”РЎРѓР С‘ Р С—Р С•Р В»РЎС“РЎвЂЎР С‘РЎвЂљ:"
    echo -e "  ${WHITE}РІР‚Сћ Р Р€Р Р…Р С‘Р С”Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– IPv6 Р Р†РЎвЂ№РЎвЂ¦Р С•Р Т‘Р Р…Р С•Р в„– Р В°Р Т‘РЎР‚Р ВµРЎРѓ${NC}"
    echo -e "  ${WHITE}РІР‚Сћ Р РЋР Р†Р С•Р в„– Р С—Р С•РЎР‚РЎвЂљ (${START_PORT}, $((START_PORT+1)), $((START_PORT+2)), ...)${NC}"
    echo -e "  ${WHITE}РІР‚Сћ Р РЋР Р†Р С•Р в„– Р В»Р С•Р С–Р С‘Р Р… Р С‘ Р С—Р В°РЎР‚Р С•Р В»РЎРЉ${NC}"
    echo ""; echo -e "  ${YELLOW}Р вЂќР С‘Р В°Р С—Р В°Р В·Р С•Р Р…: 1 РІР‚вЂњ 1000${NC}"
    echo ""; print_line; echo ""
    while true; do
        echo -ne "  ${WHITE}Р С™Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С• Р С—РЎР‚Р С•Р С”РЎРѓР С‘: ${NC}"; read -r cnt
        if [[ "$cnt" =~ ^[0-9]+$ ]] && (( cnt >= 1 && cnt <= 1000 )); then
            PROXY_COUNT=$cnt; break
        else
            err "Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ РЎвЂЎР С‘РЎРѓР В»Р С• Р С•РЎвЂљ 1 Р Т‘Р С• 1000"
        fi
    done
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# WIZARD РІР‚вЂќ STEP 3: PROTOCOL
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

step_protocol() {
    print_banner
    echo -e "  ${WHITE}${BOLD}Р РЃР В°Р С– 3 Р С‘Р В· 6 РІР‚вЂќ Р СџРЎР‚Р С•РЎвЂљР С•Р С”Р С•Р В» Р С—РЎР‚Р С•Р С”РЎРѓР С‘${NC}\n"
    print_line; echo ""
    echo -e "  ${GREEN}[1]${NC}  ${WHITE}${BOLD}SOCKS5${NC}  РІР‚вЂќ РЎС“Р Р…Р С‘Р Р†Р ВµРЎР‚РЎРѓР В°Р В»РЎРЉР Р…РЎвЂ№Р в„–, Р С—Р С•Р Т‘Р Т‘Р ВµРЎР‚Р В¶Р С‘Р Р†Р В°Р ВµРЎвЂљ TCP Р С‘ UDP"
    echo -e "       ${YELLOW}Р СџР С•Р Т‘РЎвЂ¦Р С•Р Т‘Р С‘РЎвЂљ Р Т‘Р В»РЎРЏ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р С•Р Р†, Р В±Р С•РЎвЂљР С•Р Р†, Р С—Р В°РЎР‚РЎРѓР ВµРЎР‚Р С•Р Р†, Р С‘Р С–РЎР‚${NC}\n"
    echo -e "  ${GREEN}[2]${NC}  ${WHITE}${BOLD}HTTP${NC}    РІР‚вЂќ РЎвЂљР С•Р В»РЎРЉР С”Р С• HTTP/HTTPS РЎвЂљРЎР‚Р В°РЎвЂћР С‘Р С”"
    echo -e "       ${YELLOW}Р СџР С•Р Т‘РЎвЂ¦Р С•Р Т‘Р С‘РЎвЂљ Р Т‘Р В»РЎРЏ Р В±РЎР‚Р В°РЎС“Р В·Р ВµРЎР‚Р С•Р Р† Р С‘ Р В±Р С•Р В»РЎРЉРЎв‚¬Р С‘Р Р…РЎРѓРЎвЂљР Р†Р В° Р С—РЎР‚Р С•Р С–РЎР‚Р В°Р СР С${NC}"
    echo ""; print_line; echo ""
    while true; do
        echo -ne "  ${WHITE}Р вЂ™Р В°РЎв‚¬ Р Р†РЎвЂ№Р В±Р С•РЎР‚ (1 Р С‘Р В»Р С‘ 2): ${NC}"; read -r ch
        case $ch in
            1) PROXY_PROTOCOL="socks5"; break ;;
            2) PROXY_PROTOCOL="http";   break ;;
            *) err "Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ 1 Р С‘Р В»Р С‘ 2" ;;
        esac
    done
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# WIZARD РІР‚вЂќ STEP 4: FORMAT
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

step_format() {
    print_banner
    echo -e "  ${WHITE}${BOLD}Р РЃР В°Р С– 4 Р С‘Р В· 6 РІР‚вЂќ Р В¤Р С•РЎР‚Р СР В°РЎвЂљ Р Р†РЎвЂ№Р Р†Р С•Р Т‘Р В°${NC}\n"
    print_line; echo ""
    echo -e "  ${GREEN}[1]${NC}  ${WHITE}IP:PORT:LOGIN:PASS${NC}"
    echo -e "       ${YELLOW}172.233.96.133:10001:mylogin:mypassword${NC}\n"
    echo -e "  ${GREEN}[2]${NC}  ${WHITE}IP:PORT@LOGIN:PASS${NC}"
    echo -e "       ${YELLOW}172.233.96.133:10001@mylogin:mypassword${NC}\n"
    echo -e "  ${GREEN}[3]${NC}  ${WHITE}LOGIN:PASS@IP:PORT${NC}"
    echo -e "       ${YELLOW}mylogin:mypassword@172.233.96.133:10001${NC}\n"
    echo -e "  ${GREEN}[4]${NC}  ${WHITE}LOGIN:PASS:IP:PORT${NC}"
    echo -e "       ${YELLOW}mylogin:mypassword:172.233.96.133:10001${NC}"
    echo ""; print_line; echo ""
    while true; do
        echo -ne "  ${WHITE}Р вЂ™Р В°РЎв‚¬ Р Р†РЎвЂ№Р В±Р С•РЎР‚ (1/2/3/4): ${NC}"; read -r ch
        case $ch in 1|2|3|4) OUTPUT_FORMAT=$ch; break ;; *) err "Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ Р С•РЎвЂљ 1 Р Т‘Р С• 4" ;; esac
    done
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# WIZARD РІР‚вЂќ STEP 5: WEB PANEL
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

step_panel() {
    print_banner
    echo -e "  ${WHITE}${BOLD}Р РЃР В°Р С– 5 Р С‘Р В· 6 РІР‚вЂќ Р вЂ™Р ВµР В±-Р С—Р В°Р Р…Р ВµР В»РЎРЉ${NC}\n"
    print_line; echo ""
    echo -e "  Р Р€РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ Р Р†Р ВµР В±-Р С—Р В°Р Р…Р ВµР В»РЎРЉ Р Т‘Р В»РЎРЏ Р С—РЎР‚Р С•РЎРѓР СР С•РЎвЂљРЎР‚Р В° Р С—РЎР‚Р С•Р С”РЎРѓР С‘?"
    echo ""
    echo -e "  ${CYAN}URL:${NC}   ${WHITE}http://Р вЂ™Р С’Р РЃ_IP/panel${NC}"
    echo -e "  ${CYAN}Р вЂ™РЎвЂ¦Р С•Р Т‘:${NC}  Р В»Р С•Р С–Р С‘Р Р… + Р С—Р В°РЎР‚Р С•Р В»РЎРЉ (Р В·Р В°РЎвЂ°Р С‘РЎвЂљР В°)"
    echo ""
    echo -e "  Р вЂ™Р С•Р В·Р СР С•Р В¶Р Р…Р С•РЎРѓРЎвЂљР С‘ Р С—Р В°Р Р…Р ВµР В»Р С‘:"
    echo -e "  ${WHITE}РІР‚Сћ Р РЋР С—Р С‘РЎРѓР С•Р С” Р Р†РЎРѓР ВµРЎвЂ¦ Р С—РЎР‚Р С•Р С”РЎРѓР С‘${NC}"
    echo -e "  ${WHITE}РІР‚Сћ Р СџР С•Р С‘РЎРѓР С” Р С‘ РЎвЂћР С‘Р В»РЎРЉРЎвЂљРЎР‚${NC}"
    echo -e "  ${WHITE}РІР‚Сћ Р С™Р Р…Р С•Р С—Р С”Р В° Р’В«Р РЋР С”Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ Р Р†РЎРѓРЎвЂР’В»${NC}"
    echo -e "  ${WHITE}РІР‚Сћ Р С™Р Р…Р С•Р С—Р С”Р В° Р’В«Р РЋР С”Р В°РЎвЂЎР В°РЎвЂљРЎРЉ .txtР’В»${NC}"
    echo -e "  ${WHITE}РІР‚Сћ Р ВР Р…РЎвЂћР С• Р С• РЎРѓР ВµРЎР‚Р Р†Р ВµРЎР‚Р Вµ (IP, РЎвЂљР С‘Р С—, Р С”Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С•)${NC}"
    echo ""; print_line; echo ""
    while true; do
        echo -ne "  ${WHITE}Р Р€РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ Р С—Р В°Р Р…Р ВµР В»РЎРЉ? (yes / no): ${NC}"; read -r ans
        case "${ans,,}" in
            yes|y|Р Т‘Р В°)  WANT_PANEL="yes"; break ;;
            no|n|Р Р…Р ВµРЎвЂљ)  WANT_PANEL="no";  break ;;
            *) err "Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ yes Р С‘Р В»Р С‘ no" ;;
        esac
    done
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# WIZARD РІР‚вЂќ STEP 6: CONFIRM
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

step_confirm() {
    print_banner
    echo -e "  ${WHITE}${BOLD}Р РЃР В°Р С– 6 Р С‘Р В· 6 РІР‚вЂќ Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЉРЎвЂљР Вµ Р С—Р ВµРЎР‚Р ВµР Т‘ РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С”Р С•Р в„–${NC}\n"
    print_line; echo ""
    echo -e "  ${GREEN}${BOLD}РІСљвЂњ  Р СћР В Р вЂўР вЂР С›Р вЂ™Р С’Р СњР ВР Р‡:${NC}"
    echo -e "  ${WHITE}   РІР‚Сћ Ubuntu 20.04 / 22.04 / 24.04 LTS${NC}"
    echo -e "  ${WHITE}   РІР‚Сћ Р СљР С‘Р Р…Р С‘Р СРЎС“Р С 512 MB RAM${NC}"
    echo -e "  ${WHITE}   РІР‚Сћ root Р Т‘Р С•РЎРѓРЎвЂљРЎС“Р С—${NC}"
    echo -e "  ${WHITE}   РІР‚Сћ Р СџР С•РЎР‚РЎвЂљРЎвЂ№ Р Р…Р Вµ Р В·Р В°Р В±Р В»Р С•Р С”Р С‘РЎР‚Р С•Р Р†Р В°Р Р…РЎвЂ№ Р С—РЎР‚Р С•Р Р†Р В°Р в„–Р Т‘Р ВµРЎР‚Р С•Р С${NC}"
    if [[ "$PROXY_TYPE" == "ipv6" ]]; then
        echo ""
        echo -e "  ${GREEN}${BOLD}РІСљвЂњ  Р вЂќР вЂєР Р‡ IPv6 Р вЂќР С›Р СџР С›Р вЂєР СњР ВР СћР вЂўР вЂєР В¬Р СњР С›:${NC}"
        echo -e "  ${WHITE}   РІР‚Сћ IPv6 Р Р†Р С”Р В»РЎР‹РЎвЂЎРЎвЂР Р… Р Р† Р С—Р В°Р Р…Р ВµР В»Р С‘ РЎС“Р С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ VPS${NC}"
        echo -e "  ${WHITE}   РІР‚Сћ Р СџРЎР‚Р С•Р Р†Р В°Р в„–Р Т‘Р ВµРЎР‚ Р Р†РЎвЂ№Р Т‘Р В°Р В» /48 Р С‘Р В»Р С‘ /64 Р С—Р С•Р Т‘РЎРѓР ВµРЎвЂљРЎРЉ${NC}"
        echo -e "  ${WHITE}   РІР‚Сћ Р В Р В°Р В·РЎР‚Р ВµРЎв‚¬Р ВµР Р…Р С• Р Т‘Р С•Р В±Р В°Р Р†Р В»РЎРЏРЎвЂљРЎРЉ Р Т‘Р С•Р С—. IPv6 Р В°Р Т‘РЎР‚Р ВµРЎРѓР В°${NC}"
        echo -e "  ${YELLOW}   РІС™В   Р В Р ВµР С”Р С•Р СР ВµР Р…Р Т‘Р С•Р Р†Р В°Р Р…Р С•: Hetzner, Vultr, DigitalOcean, Aeza${NC}"
    fi
    echo ""
    echo -e "  ${CYAN}${BOLD}РІС™в„ў  Р вЂР Р€Р вЂќР вЂўР Сћ Р Р€Р РЋР СћР С’Р СњР С›Р вЂ™Р вЂєР вЂўР СњР С›:${NC}"
    echo -e "  ${WHITE}   РІР‚Сћ 3proxy (SOCKS5, Р С‘Р В· Р С‘РЎРѓРЎвЂ¦Р С•Р Т‘Р Р…Р С‘Р С”Р С•Р Р†)${NC}"
    echo -e "  ${WHITE}   РІР‚Сћ UFW firewall${NC}"
    echo -e "  ${WHITE}   РІР‚Сћ Systemd РЎРѓР ВµРЎР‚Р Р†Р С‘РЎРѓ Р В°Р Р†РЎвЂљР С•Р В·Р В°Р С—РЎС“РЎРѓР С”Р В°${NC}"
    [[ "$PROXY_TYPE" == "ipv6" ]] && echo -e "  ${WHITE}   РІР‚Сћ IPv6 Р В°Р Т‘РЎР‚Р ВµРЎРѓР В° + sysctl forwarding${NC}"
    [[ "$WANT_PANEL" == "yes" ]] && echo -e "  ${WHITE}   РІР‚Сћ Nginx + Р Р†Р ВµР В±-Р С—Р В°Р Р…Р ВµР В»РЎРЉ (Р В·Р В°РЎвЂ°Р С‘РЎвЂ°Р ВµР Р…Р В° Р С—Р В°РЎР‚Р С•Р В»Р ВµР С)${NC}"
    echo ""
    print_line; echo ""
    echo -e "  ${WHITE}${BOLD}Р ВРЎвЂљР С•Р С–Р С•:${NC}"
    echo -e "  ${CYAN}  Р СћР С‘Р С—:        ${WHITE}$PROXY_TYPE${NC}"
    echo -e "  ${CYAN}  Р СџРЎР‚Р С•РЎвЂљР С•Р С”Р С•Р В»:   ${WHITE}${PROXY_PROTOCOL^^}${NC}"
    echo -e "  ${CYAN}  Р С™Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С•: ${WHITE}$PROXY_COUNT${NC}"
    echo -e "  ${CYAN}  Р В¤Р С•РЎР‚Р СР В°РЎвЂљ:     ${WHITE}$(format_name)${NC}"
    echo -e "  ${CYAN}  Р СџР С•РЎР‚РЎвЂљРЎвЂ№:      ${WHITE}${START_PORT} РІР‚вЂњ $((START_PORT + PROXY_COUNT - 1))${NC}"
    echo -e "  ${CYAN}  Р СџР В°Р Р…Р ВµР В»РЎРЉ:     ${WHITE}$WANT_PANEL${NC}"
    echo ""; print_line; echo ""
    while true; do
        echo -ne "  ${WHITE}Р СњР В°РЎвЂЎР В°РЎвЂљРЎРЉ РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С”РЎС“? (yes / no): ${NC}"; read -r ans
        case "${ans,,}" in
            yes|y|Р Т‘Р В°) break ;;
            no|n|Р Р…Р ВµРЎвЂљ) echo "  Р С›РЎвЂљР СР ВµР Р…Р В°."; exit 0 ;;
            *) warn "Р вЂ™Р Р†Р ВµР Т‘Р С‘РЎвЂљР Вµ yes Р С‘Р В»Р С‘ no" ;;
        esac
    done
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# INSTALL DEPS + 3PROXY
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

install_dependencies() {
    step "Р С›Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘Р Вµ Р С—Р В°Р С”Р ВµРЎвЂљР С•Р Р†..."
    apt-get update -qq
    local pkgs="build-essential curl wget tar iproute2 ufw python3 net-tools"
    [[ "$WANT_PANEL" == "yes" ]] && pkgs="$pkgs nginx apache2-utils"
    DEBIAN_FRONTEND=noninteractive apt-get install -y -qq $pkgs > /dev/null 2>&1
    success "Р вЂ”Р В°Р Р†Р С‘РЎРѓР С‘Р СР С•РЎРѓРЎвЂљР С‘ РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…РЎвЂ№"
}

install_3proxy() {
    step "Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° 3proxy..."
    local ver
    ver=$(curl -s --max-time 10 https://api.github.com/repos/3proxy/3proxy/releases/latest \
          | grep '"tag_name"' | cut -d'"' -f4 | tr -d 'v' || true)
    [[ -z "$ver" || "$ver" == "null" ]] && ver="0.9.4"
    info "Р вЂ™Р ВµРЎР‚РЎРѓР С‘РЎРЏ: $ver"

    cd /tmp
    rm -rf 3proxy-build && mkdir 3proxy-build && cd 3proxy-build
    wget -q "https://github.com/3proxy/3proxy/archive/refs/tags/${ver}.tar.gz" -O src.tar.gz \
        || { err "Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ 3proxy"; exit 1; }
    tar -xzf src.tar.gz
    cd "3proxy-${ver}"

    step "Р С™Р С•Р СР С—Р С‘Р В»РЎРЏРЎвЂ Р С‘РЎРЏ..."
    make -f Makefile.Linux > /dev/null 2>&1
    mkdir -p "$INSTALL_DIR"
    cp src/3proxy "$INSTALL_DIR/3proxy"
    chmod +x "$INSTALL_DIR/3proxy"
    mkdir -p "$LOG_DIR"
    success "3proxy v${ver} РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р В»Р ВµР Р…"
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# NETWORK DETECTION
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

detect_network() {
    step "Р С›Р С—РЎР‚Р ВµР Т‘Р ВµР В»Р ВµР Р…Р С‘Р Вµ РЎРѓР ВµРЎвЂљР ВµР Р†РЎвЂ№РЎвЂ¦ Р С—Р В°РЎР‚Р В°Р СР ВµРЎвЂљРЎР‚Р С•Р Р†..."
    SERVER_IPV4=$(curl -s -4 --max-time 8 ifconfig.me \
                  || ip -4 addr show | grep 'global' | awk '{print $2}' | cut -d'/' -f1 | head -1)
    info "IPv4: $SERVER_IPV4"

    if [[ "$PROXY_TYPE" == "ipv6" ]]; then
        local ipv6_line
        ipv6_line=$(ip -6 addr show | grep 'scope global' | grep -v 'temporary' | head -1)
        if [[ -z "$ipv6_line" ]]; then
            err "Р вЂњР В»Р С•Р В±Р В°Р В»РЎРЉР Р…РЎвЂ№Р в„– IPv6 Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…. Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР С‘РЎвЂљР Вµ IPv6 Р Р† Р С—Р В°Р Р…Р ВµР В»Р С‘ VPS."
            echo -e "\n  Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЉРЎвЂљР Вµ: ${WHITE}ip -6 addr show${NC}\n"; exit 1
        fi
        local ipv6_cidr
        ipv6_cidr=$(echo "$ipv6_line" | awk '{print $2}')
        IPV6_ADDR=$(echo "$ipv6_cidr" | cut -d'/' -f1)
        IPV6_PREFIX_LEN=$(echo "$ipv6_cidr" | cut -d'/' -f2)
        NET_INTERFACE=$(ip -6 route show default | awk '{print $5}' | head -1)
        [[ -z "$NET_INTERFACE" ]] && \
            NET_INTERFACE=$(ip link show | grep -v 'lo' | grep 'state UP' \
                            | awk -F': ' '{print $2}' | head -1)
        info "Р ВР Р…РЎвЂљР ВµРЎР‚РЎвЂћР ВµР в„–РЎРѓ: $NET_INTERFACE"
        info "IPv6: ${IPV6_ADDR}/${IPV6_PREFIX_LEN}"
    fi
    success "Р РЋР ВµРЎвЂљР ВµР Р†РЎвЂ№Р Вµ Р С—Р В°РЎР‚Р В°Р СР ВµРЎвЂљРЎР‚РЎвЂ№ Р С•Р С—РЎР‚Р ВµР Т‘Р ВµР В»Р ВµР Р…РЎвЂ№"
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# IPv6 GENERATION
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

generate_ipv6() {
    step "Р вЂњР ВµР Р…Р ВµРЎР‚Р В°РЎвЂ Р С‘РЎРЏ $PROXY_COUNT IPv6 Р В°Р Т‘РЎР‚Р ВµРЎРѓР С•Р Р†..."
    local prefix64
    prefix64=$(python3 - <<PYEOF
import ipaddress, sys
try:
    net = ipaddress.IPv6Network("${IPV6_ADDR}/64", strict=False)
    print(str(net.network_address))
except:
    sys.exit(1)
PYEOF
    )
    [[ -z "$prefix64" ]] && { err "Р СњР Вµ РЎС“Р Т‘Р В°Р В»Р С•РЎРѓРЎРЉ Р С•Р С—РЎР‚Р ВµР Т‘Р ВµР В»Р С‘РЎвЂљРЎРЉ /64 Р С‘Р В· ${IPV6_ADDR}"; exit 1; }
    info "Р СџР С•Р Т‘РЎРѓР ВµРЎвЂљРЎРЉ /64: ${prefix64}/64"

    declare -A seen=()
    local i=0
    while (( i < PROXY_COUNT )); do
        local addr
        addr=$(python3 - <<PYEOF
import ipaddress, random
base = ipaddress.IPv6Network("${prefix64}/64", strict=False)
host_int = random.randint(2, (2**64) - 2)
print(str(base.network_address + host_int))
PYEOF
        )
        if [[ -z "${seen[$addr]:-}" ]]; then
            seen[$addr]=1
            IPV6_ADDRESSES+=("$addr")
            (( i++ ))
        fi
    done
    success "Р РЋР С–Р ВµР Р…Р ВµРЎР‚Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С• ${#IPV6_ADDRESSES[@]} Р В°Р Т‘РЎР‚Р ВµРЎРѓР С•Р Р†"
}

add_ipv6_addresses() {
    step "Р вЂќР С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘Р Вµ IPv6 Р В°Р Т‘РЎР‚Р ВµРЎРѓР С•Р Р† Р Р…Р В° $NET_INTERFACE..."
    cat > "$IPV6_SCRIPT" <<'SCRIPT'
#!/bin/bash
# Auto-generated by proxy-installer
SCRIPT
    local count=0
    for addr in "${IPV6_ADDRESSES[@]}"; do
        echo "ip -6 addr add ${addr}/64 dev $NET_INTERFACE 2>/dev/null || true" >> "$IPV6_SCRIPT"
        ip -6 addr add "${addr}/64" dev "$NET_INTERFACE" 2>/dev/null || true
        (( count++ ))
        (( count % 100 == 0 )) && info "Р вЂќР С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С• $count / $PROXY_COUNT..."
    done
    chmod +x "$IPV6_SCRIPT"

    cat > /etc/systemd/system/add-proxy-ipv6.service <<EOF
[Unit]
Description=Add IPv6 addresses for proxy
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=$IPV6_SCRIPT
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable add-proxy-ipv6.service > /dev/null 2>&1
    success "IPv6 Р В°Р Т‘РЎР‚Р ВµРЎРѓР В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…РЎвЂ№ (Р В°Р Р†РЎвЂљР С•Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р В°)"
}

configure_ipv6_kernel() {
    step "Р вЂ™Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С‘Р Вµ IPv6 forwarding..."
    sysctl -w net.ipv6.conf.all.forwarding=1     > /dev/null 2>&1
    sysctl -w net.ipv6.conf.all.proxy_ndp=1      > /dev/null 2>&1
    sysctl -w net.ipv6.conf.default.forwarding=1 > /dev/null 2>&1
    grep -q "net.ipv6.conf.all.forwarding" /etc/sysctl.conf || \
    cat >> /etc/sysctl.conf <<'EOF'

# IPv6 proxy
net.ipv6.conf.all.forwarding=1
net.ipv6.conf.default.forwarding=1
net.ipv6.conf.all.proxy_ndp=1
EOF
    sysctl -p > /dev/null 2>&1 || true
    success "IPv6 forwarding Р Р†Р С”Р В»РЎР‹РЎвЂЎРЎвЂР Р…"
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# 3PROXY CONFIG
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

configure_3proxy() {
    step "Р вЂњР ВµР Р…Р ВµРЎР‚Р В°РЎвЂ Р С‘РЎРЏ Р С”Р С•Р Р…РЎвЂћР С‘Р С–РЎС“РЎР‚Р В°РЎвЂ Р С‘Р С‘ ($PROXY_COUNT Р С—РЎР‚Р С•Р С”РЎРѓР С‘)..."

    cat > "$CONFIG_FILE" <<EOF
# Generated by proxy-installer РІР‚вЂќ $(date)
# Type: $PROXY_TYPE | Count: $PROXY_COUNT

nscache 65536
timeouts 1 5 30 60 180 1800 15 60
daemon
pidfile /var/run/3proxy.pid
log $LOG_DIR/3proxy.log D
logformat "- +_L%t.%.  %N.%p %E %U %C:%c %R:%r %O %I %h %T"
rotate 30
maxconn 200

auth strong

EOF

    PROXY_LOGINS=(); PROXY_PASSES=()
    for (( i=0; i<PROXY_COUNT; i++ )); do
        local login pass
        login="u$(printf '%04d' $((i+1)))_$(gen_random 6)"
        pass=$(gen_random 14)
        PROXY_LOGINS+=("$login")
        PROXY_PASSES+=("$pass")
        echo "users ${login}:CL:${pass}" >> "$CONFIG_FILE"
    done

    echo "" >> "$CONFIG_FILE"
    for (( i=0; i<PROXY_COUNT; i++ )); do
        local port=$((START_PORT + i))
        echo "allow ${PROXY_LOGINS[$i]}" >> "$CONFIG_FILE"
        [[ "$PROXY_TYPE" == "ipv6" ]] && echo "external ${IPV6_ADDRESSES[$i]}" >> "$CONFIG_FILE"
        if [[ "$PROXY_PROTOCOL" == "http" ]]; then
            echo "proxy -i0.0.0.0 -p${port}" >> "$CONFIG_FILE"
        else
            echo "socks -i0.0.0.0 -p${port}" >> "$CONFIG_FILE"
        fi
        echo "flush" >> "$CONFIG_FILE"
        echo "" >> "$CONFIG_FILE"
    done

    success "Р С™Р С•Р Р…РЎвЂћР С‘Р С–РЎС“РЎР‚Р В°РЎвЂ Р С‘РЎРЏ Р В·Р В°Р С—Р С‘РЎРѓР В°Р Р…Р В°"

    step "Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С‘Р Вµ РЎРѓР С—Р С‘РЎРѓР С”Р В° Р С—РЎР‚Р С•Р С”РЎРѓР С‘..."
    > "$PROXY_LIST"
    for (( i=0; i<PROXY_COUNT; i++ )); do
        format_proxy "$SERVER_IPV4" "$((START_PORT+i))" "${PROXY_LOGINS[$i]}" "${PROXY_PASSES[$i]}" >> "$PROXY_LIST"
    done
    success "Р РЋР С—Р С‘РЎРѓР С•Р С”: $PROXY_LIST"
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# 3PROXY SYSTEMD
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

setup_3proxy_service() {
    step "Systemd РЎРѓР ВµРЎР‚Р Р†Р С‘РЎРѓ 3proxy..."
    local after="network-online.target"
    local wants="network-online.target"
    [[ "$PROXY_TYPE" == "ipv6" ]] && after="$after add-proxy-ipv6.service" && wants="$wants add-proxy-ipv6.service"

    cat > /etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy Proxy Server
After=$after
Wants=$wants

[Service]
Type=forking
PIDFile=/var/run/3proxy.pid
ExecStart=$INSTALL_DIR/3proxy $CONFIG_FILE
ExecReload=/bin/kill -HUP \$MAINPID
Restart=on-failure
RestartSec=10
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable 3proxy > /dev/null 2>&1
    systemctl restart 3proxy || true
    sleep 3
    if systemctl is-active --quiet 3proxy; then
        success "3proxy Р В·Р В°Р С—РЎС“РЎвЂ°Р ВµР Р…"
    else
        warn "3proxy Р Р…Р Вµ Р В·Р В°Р С—РЎС“РЎРѓРЎвЂљР С‘Р В»РЎРѓРЎРЏ. Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЉРЎвЂљР Вµ: journalctl -u 3proxy -n 30"
    fi
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# FIREWALL
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

setup_firewall() {
    step "Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р В° UFW..."
    sed -i 's/^IPV6=no/IPV6=yes/' /etc/default/ufw 2>/dev/null || true
    ufw --force enable > /dev/null 2>&1
    ufw allow OpenSSH  > /dev/null 2>&1
    [[ "$WANT_PANEL" == "yes" ]] && ufw allow 80/tcp > /dev/null 2>&1

    local end_port=$((START_PORT + PROXY_COUNT - 1))
    if (( PROXY_COUNT == 1 )); then
        ufw allow "${START_PORT}/tcp" > /dev/null 2>&1
    else
        ufw allow "${START_PORT}:${end_port}/tcp" > /dev/null 2>&1
    fi
    ufw reload > /dev/null 2>&1
    success "Firewall: SSH + Р С—Р С•РЎР‚РЎвЂљРЎвЂ№ Р С—РЎР‚Р С•Р С”РЎРѓР С‘ Р С•РЎвЂљР С”РЎР‚РЎвЂ№РЎвЂљРЎвЂ№$( [[ "$WANT_PANEL" == "yes" ]] && echo " + 80/tcp" )"
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# WEB PANEL
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

generate_panel_html() {
    local ip=$1 ptype=$2 pproto=$3 pcount=$4 fmt=$5

    mkdir -p "$PANEL_DIR"

    # Build JS proxy array
    local js_list=""
    while IFS= read -r line; do
        js_list+="\"$(echo "$line" | sed 's/\\/\\\\/g; s/"/\\"/g')\","$'\n'
    done < "$PROXY_LIST"

    cat > "${PANEL_DIR}/index.html" <<HTMLEOF
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proxy Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  ::-webkit-scrollbar{width:6px;height:6px}
  ::-webkit-scrollbar-track{background:#1e293b}
  ::-webkit-scrollbar-thumb{background:#475569;border-radius:3px}
  .proxy-line{font-family:'Courier New',monospace;font-size:13px}
  .fade-in{animation:fadeIn .3s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
  .copy-flash{animation:flash .4s ease}
  @keyframes flash{0%,100%{background-color:transparent}50%{background-color:rgba(34,197,94,.15)}}
</style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

<!-- Header -->
<div class="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <div class="w-8 h-8 bg-cyan-500 rounded-lg flex items-center justify-center text-slate-900 font-bold text-sm">P</div>
    <div>
      <div class="font-semibold text-white">Proxy Panel</div>
      <div class="text-xs text-slate-400">${ip}</div>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <span class="px-2 py-1 rounded text-xs font-medium $( [[ "$ptype" == "ipv6" ]] && echo "bg-purple-500/20 text-purple-300" || echo "bg-blue-500/20 text-blue-300" )">${ptype^^}</span>
    <span class="px-2 py-1 bg-slate-700 rounded text-xs text-slate-300">${pcount} Р С—РЎР‚Р С•Р С”РЎРѓР С‘</span>
  </div>
</div>

<!-- Stats -->
<div class="px-6 py-5 grid grid-cols-2 md:grid-cols-4 gap-4">
  <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
    <div class="text-xs text-slate-400 mb-1">Р РЋР ВµРЎР‚Р Р†Р ВµРЎР‚</div>
    <div class="font-mono text-sm text-cyan-400">${ip}</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
    <div class="text-xs text-slate-400 mb-1">Р СћР С‘Р С—</div>
    <div class="font-semibold text-white">${ptype^^} ${pproto^^}</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
    <div class="text-xs text-slate-400 mb-1">Р С™Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С•</div>
    <div class="font-semibold text-white" id="totalCount">${pcount}</div>
  </div>
  <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
    <div class="text-xs text-slate-400 mb-1">Р В¤Р С•РЎР‚Р СР В°РЎвЂљ</div>
    <div class="text-xs font-mono text-slate-300">${fmt}</div>
  </div>
</div>

<!-- Controls -->
<div class="px-6 pb-4 flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between">
  <div class="relative flex-1 max-w-md">
    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
    </svg>
    <input id="searchInput" type="text" placeholder="Р СџР С•Р С‘РЎРѓР С” Р С—Р С• IP, Р С—Р С•РЎР‚РЎвЂљРЎС“, Р В»Р С•Р С–Р С‘Р Р…РЎС“..."
      class="w-full bg-slate-800 border border-slate-600 rounded-lg pl-10 pr-4 py-2 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-cyan-500 transition-colors"
      oninput="filterProxies()">
  </div>
  <div class="flex gap-2">
    <button onclick="copyAll()"
      class="flex items-center gap-2 px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-medium rounded-lg transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
      </svg>
      <span id="copyBtnText">Р РЋР С”Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ Р Р†РЎРѓРЎвЂ</span>
    </button>
    <button onclick="downloadTxt()"
      class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
      </svg>
      Р РЋР С”Р В°РЎвЂЎР В°РЎвЂљРЎРЉ .txt
    </button>
  </div>
</div>

<!-- Proxy list -->
<div class="px-6 pb-8">
  <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
    <div class="px-4 py-2 bg-slate-750 border-b border-slate-700 flex items-center justify-between">
      <span class="text-xs text-slate-400">Р РЋР С—Р С‘РЎРѓР С•Р С” Р С—РЎР‚Р С•Р С”РЎРѓР С‘</span>
      <span id="visibleCount" class="text-xs text-slate-500">${pcount} Р В·Р В°Р С—Р С‘РЎРѓР ВµР в„–</span>
    </div>
    <div id="proxyList" class="divide-y divide-slate-700/50 max-h-[60vh] overflow-y-auto">
    </div>
  </div>
</div>

<script>
const proxies = [
${js_list}
];

const filtered = { list: [...proxies] };

function renderList(list) {
  const container = document.getElementById('proxyList');
  if (list.length === 0) {
    container.innerHTML = '<div class="px-4 py-8 text-center text-slate-500 text-sm">Р СњР С‘РЎвЂЎР ВµР С–Р С• Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р С•</div>';
    return;
  }
  container.innerHTML = list.map((p, i) =>
    '<div class="flex items-center gap-3 px-4 py-2 hover:bg-slate-700/40 transition-colors group fade-in" data-proxy="' + p.replace(/"/g,'&quot;') + '">' +
    '<span class="text-xs text-slate-600 w-6 text-right select-none">' + (i+1) + '</span>' +
    '<span class="proxy-line flex-1 text-slate-200 break-all">' + p + '</span>' +
    '<button onclick="copySingle(this)" data-val="' + p.replace(/"/g,'&quot;') + '"' +
    ' class="opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded text-slate-400 hover:text-cyan-400" title="Р РЋР С”Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ">' +
    '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>' +
    '</button></div>'
  ).join('');
}

function filterProxies() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const list = q ? proxies.filter(p => p.toLowerCase().includes(q)) : proxies;
  filtered.list = list;
  document.getElementById('visibleCount').textContent = list.length + ' Р В·Р В°Р С—Р С‘РЎРѓР ВµР в„–';
  renderList(list);
}

function copyAll() {
  const text = filtered.list.join('\n');
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copyBtnText');
    btn.textContent = 'РІСљвЂњ Р РЋР С”Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С•!';
    setTimeout(() => btn.textContent = 'Р РЋР С”Р С•Р С—Р С‘РЎР‚Р С•Р Р†Р В°РЎвЂљРЎРЉ Р Р†РЎРѓРЎвЂ', 2000);
  });
}

function copySingle(btn) {
  navigator.clipboard.writeText(btn.dataset.val).then(() => {
    btn.innerHTML = '<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
    setTimeout(() => {
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>';
    }, 2000);
  });
}

function downloadTxt() {
  const text = filtered.list.join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
  a.download = 'proxies_${ip}.txt';
  a.click();
}

renderList(proxies);
</script>
</body>
</html>
HTMLEOF
}

setup_web_panel() {
    step "Р СњР В°РЎРѓРЎвЂљРЎР‚Р С•Р в„–Р С”Р В° Р Р†Р ВµР В±-Р С—Р В°Р Р…Р ВµР В»Р С‘..."
    PANEL_PASS=$(gen_random 16)

    generate_panel_html "$SERVER_IPV4" "$PROXY_TYPE" "$PROXY_PROTOCOL" "$PROXY_COUNT" "$(format_name)"

    # Nginx config
    cat > /etc/nginx/sites-available/proxy-panel <<'EOF'
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    location /panel/ {
        alias /var/www/html/panel/;
        index index.html;
        auth_basic "Proxy Panel";
        auth_basic_user_file /etc/nginx/.htpasswd-panel;
        try_files $uri $uri/ =404;
    }

    location /panel {
        return 301 /panel/;
    }

    location / {
        return 301 /panel/;
    }
}
EOF

    # Remove default site, enable ours
    rm -f /etc/nginx/sites-enabled/default
    ln -sf /etc/nginx/sites-available/proxy-panel /etc/nginx/sites-enabled/proxy-panel

    # Create htpasswd
    htpasswd -bc /etc/nginx/.htpasswd-panel "$PANEL_USER" "$PANEL_PASS" > /dev/null 2>&1

    # Save credentials
    cat > "$PANEL_CREDS" <<EOF
# Р вЂ™Р ВµР В±-Р С—Р В°Р Р…Р ВµР В»РЎРЉ Р С—РЎР‚Р С•Р С”РЎРѓР С‘
URL:      http://${SERVER_IPV4}/panel
Р вЂєР С•Р С–Р С‘Р Р…:    ${PANEL_USER}
Р СџР В°РЎР‚Р С•Р В»РЎРЉ:   ${PANEL_PASS}
EOF
    chmod 600 "$PANEL_CREDS"

    # Create update command
    cat > "$UPDATE_PANEL_CMD" <<'UPDATEEOF'
#!/bin/bash
# Regenerates panel HTML from current proxy_list.txt
source /etc/3proxy/panel_vars
UPDATEEOF

    # Store vars for regeneration
    cat > /etc/3proxy/panel_vars <<EOF
SERVER_IPV4="$SERVER_IPV4"
PROXY_TYPE="$PROXY_TYPE"
PROXY_PROTOCOL="$PROXY_PROTOCOL"
PROXY_COUNT="$PROXY_COUNT"
OUTPUT_FORMAT="$OUTPUT_FORMAT"
EOF

    nginx -t > /dev/null 2>&1 && systemctl restart nginx || {
        warn "Nginx Р Р…Р Вµ Р В·Р В°Р С—РЎС“РЎРѓРЎвЂљР С‘Р В»РЎРѓРЎРЏ. Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЉРЎвЂљР Вµ: nginx -t"
    }

    systemctl enable nginx > /dev/null 2>&1
    success "Р вЂ™Р ВµР В±-Р С—Р В°Р Р…Р ВµР В»РЎРЉ: http://${SERVER_IPV4}/panel"
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# RESULTS
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

print_results() {
    if [[ -t 1 ]] && command -v clear >/dev/null 2>&1; then
        clear || true
    fi
    echo -e "${GREEN}"
    echo "  РІвЂўвЂќРІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўвЂ”"
    echo "  РІвЂўвЂ                                                  РІвЂўвЂ"
    echo "  РІвЂўвЂ       РІСљвЂњ   Р Р€Р РЋР СћР С’Р СњР С›Р вЂ™Р С™Р С’ Р вЂ”Р С’Р вЂ™Р вЂўР В Р РЃР вЂўР СњР С’ Р Р€Р РЋР СџР вЂўР РЃР СњР С›!           РІвЂўвЂ"
    echo "  РІвЂўвЂ                                                  РІвЂўвЂ"
    echo "  РІвЂўС™РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўСњ"
    echo -e "${NC}"
    print_line; echo ""
    echo -e "  ${WHITE}${BOLD}Р СџР В°РЎР‚Р В°Р СР ВµРЎвЂљРЎР‚РЎвЂ№:${NC}"
    echo -e "  ${CYAN}  Р СћР С‘Р С—:        ${WHITE}$PROXY_TYPE${NC}"
    echo -e "  ${CYAN}  Р СџРЎР‚Р С•РЎвЂљР С•Р С”Р С•Р В»:   ${WHITE}${PROXY_PROTOCOL^^}${NC}"
    echo -e "  ${CYAN}  Р С™Р С•Р В»Р С‘РЎвЂЎР ВµРЎРѓРЎвЂљР Р†Р С•: ${WHITE}$PROXY_COUNT${NC}"
    echo -e "  ${CYAN}  Р В¤Р С•РЎР‚Р СР В°РЎвЂљ:     ${WHITE}$(format_name)${NC}"
    echo -e "  ${CYAN}  Р СџР С•РЎР‚РЎвЂљРЎвЂ№:      ${WHITE}${START_PORT} РІР‚вЂњ $((START_PORT + PROXY_COUNT - 1))${NC}"
    echo ""

    if [[ "$WANT_PANEL" == "yes" ]]; then
        echo -e "  ${CYAN}${BOLD}  Р вЂ™Р ВµР В±-Р С—Р В°Р Р…Р ВµР В»РЎРЉ:${NC}"
        echo -e "  ${WHITE}  URL:     ${GREEN}http://${SERVER_IPV4}/panel${NC}"
        echo -e "  ${WHITE}  Р вЂєР С•Р С–Р С‘Р Р…:   ${GREEN}${PANEL_USER}${NC}"
        echo -e "  ${WHITE}  Р СџР В°РЎР‚Р С•Р В»РЎРЉ:  ${GREEN}${PANEL_PASS}${NC}"
        echo -e "  ${YELLOW}  Р РЋР С•РЎвЂ¦РЎР‚Р В°Р Р…Р ВµР Р…Р С• Р Р†: $PANEL_CREDS${NC}"
        echo ""
    fi

    print_line; echo ""
    echo -e "  ${WHITE}${BOLD}Р СџР ВµРЎР‚Р Р†РЎвЂ№Р Вµ Р С—РЎР‚Р С•Р С”РЎРѓР С‘:${NC}"; echo ""
    local shown=0
    while IFS= read -r line && (( shown < 10 )); do
        echo -e "  ${GREEN}$line${NC}"; (( shown++ ))
    done < "$PROXY_LIST"
    (( PROXY_COUNT > 10 )) && echo -e "\n  ${YELLOW}  ... Р С‘ Р ВµРЎвЂ°РЎвЂ $((PROXY_COUNT - 10)) Р Р† РЎвЂћР В°Р в„–Р В»Р Вµ${NC}"
    echo ""
    print_line; echo ""
    echo -e "  ${WHITE}${BOLD}Р СџР С•Р В»Р Р…РЎвЂ№Р в„– РЎРѓР С—Р С‘РЎРѓР С•Р С”:${NC}"
    echo -e "  ${CYAN}  cat $PROXY_LIST${NC}"
    echo ""
    echo -e "  ${WHITE}${BOLD}Р Р€Р С—РЎР‚Р В°Р Р†Р В»Р ВµР Р…Р С‘Р Вµ:${NC}"
    echo -e "  ${CYAN}  systemctl status  3proxy${NC}  РІР‚вЂќ РЎРѓРЎвЂљР В°РЎвЂљРЎС“РЎРѓ"
    echo -e "  ${CYAN}  systemctl restart 3proxy${NC}  РІР‚вЂќ Р С—Р ВµРЎР‚Р ВµР В·Р В°Р С—РЎС“РЎРѓР С”"
    echo -e "  ${CYAN}  systemctl stop    3proxy${NC}  РІР‚вЂќ Р С•РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С‘РЎвЂљРЎРЉ"
    echo ""; print_line; echo ""
}

# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’
# MAIN
# РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’РІвЂўС’

main() {
    check_root
    check_os

    step_proxy_type
    step_proxy_count
    step_protocol
    step_format
    step_panel
    step_confirm

    print_banner
    echo -e "  ${WHITE}${BOLD}Р Р€РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С”Р В°...${NC}\n"

    install_dependencies
    install_3proxy
    detect_network

    if [[ "$PROXY_TYPE" == "ipv6" ]]; then
        generate_ipv6
        add_ipv6_addresses
        configure_ipv6_kernel
    fi

    configure_3proxy
    setup_firewall
    setup_3proxy_service
    [[ "$WANT_PANEL" == "yes" ]] && setup_web_panel

    print_results
}

main "$@"
